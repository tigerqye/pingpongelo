<!DOCTYPE html>
<html>

<head>
    <title>Pong League</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèì</text></svg>">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            text-align: center;
        }

        h1,
        h2 {
            color: #ffffff;
        }

        #loader-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #121212;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.8s ease, visibility 0.8s;
        }

        .loader-content {
            text-align: center;
        }

        /* Text Animation */
        .loader-text {
            font-size: 2.5em;
            color: white;
            margin: 0;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 1s forwards 0.5s;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loader-hidden {
            opacity: 0;
            visibility: hidden;
        }

        /* Interactive Title and Icon Header */
        #header-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            width: 100%;
            position: relative;
        }

        #pong-title {
            cursor: pointer;
            user-select: none;
            margin: 0;
            z-index: 10;
        }

        /* Floating Action Button (FAB) */
        #fab-add-match {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background-color: #4CAF50;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            z-index: 999;
            transition: transform 0.2s, background-color 0.2s;
            border: none;
        }

        #fab-add-match:hover {
            transform: scale(1.1);
            background-color: #45a049;
        }

        /* Adjusting the existing modal styles to ensure the log form looks good */
        .modal-content label {
            display: block;
            text-align: left;
            color: #888;
            margin-top: 10px;
            font-size: 0.9em;
        }

        /* Rules icon */
        #rules-icon {
            cursor: pointer;
            color: #e0e0e0;
            background: #333;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Georgia', serif;
            font-style: italic;
            font-weight: bold;
            font-size: 1.2em;
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            transition: background 0.2s;
        }

        #rules-icon:hover {
            background: #4CAF50;
            color: white;
        }

        /* Admin Note Styling */
        .top-banner {
            background: #3a3a3a;
            padding: 10px 20px;
            border-radius: 8px;
            margin: 10px auto 20px auto;
            max-width: 600px;
            font-size: 0.9em;
            font-weight: 500;
            text-align: center;
        }

        #league-note {
            color: #ffeb3b;
            border-left: 5px solid #ff9800;
            border-right: 5px solid #ff9800;
        }

        #last-match-banner {
            border-left: 5px solid #4CAF50;
            border-right: 5px solid #4CAF50;
        }

        /* Tournament Styles */
        /* --- NEW STYLES FOR SCROLLABLE BRACKET --- */
        #bracket-container {
            overflow-x: auto;
            /* Enable horizontal scrolling */
            padding-bottom: 10px;
            /* Space for scrollbar */
        }

        #bracket-rounds {
            display: flex;
            /* Arrange rounds horizontally */
            width: fit-content;
            /* Allow the content to expand beyond the screen */
            padding: 10px 0;
        }

        .bracket-round {
            flex-shrink: 0;
            /* Prevent rounds from shrinking */
            width: 280px;
            /* Fixed width for each round column */
            margin-right: 20px;
            padding-right: 10px;
            border-right: 1px dashed #333;
        }

        .bracket-round:last-child {
            border-right: none;
            margin-right: 0;
        }

        .round-matches {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            /* Spacing between matches */
        }

        .match-entry {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            /* margin-bottom: 10px; REMOVED, controlled by gap in .round-matches */
            text-align: left;
            transition: all 0.3s;
        }

        .match-entry.completed {
            background: #1a1a1a;
            color: #777;
            border: 1px solid #4CAF5055;
        }

        .match-entry.completed .match-players,
        .match-entry.completed .match-header strong {
            color: #ccc;
        }

        .match-entry.future {
            background: #222;
            color: #888;
            border: 1px solid #444;
        }

        .match-entry.future .match-players {
            font-weight: normal;
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        .match-header span {
            color: #888;
            font-size: 0.8em;
        }

        .match-players {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .match-players .vs {
            color: #888;
            font-weight: normal;
            margin: 0 8px;
        }

        .match-status {
            color: #F44336;
            font-size: 0.9em;
            font-weight: bold;
        }

        .match-status.completed {
            color: #4CAF50;
        }

        .match-status.future {
            color: #ffeb3b;
        }

        .match-winner {
            color: #4CAF50;
            font-weight: bold;
            font-size: 1.1em;
            margin-top: 5px;
        }

        .match-winner.bye {
            color: #2196F3;
        }

        /* --- END NEW STYLES --- */

        /* Card Style */
        .card {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th {
            text-align: left;
            color: #888;
            border-bottom: 1px solid #333;
            padding: 10px;
            font-size: 0.9em;
        }

        td {
            padding: 8px 10px;
            border-bottom: 1px solid #2a2a2a;
            text-align: left;
        }

        .elo {
            font-weight: bold;
            color: #4CAF50;
        }

        .rank {
            color: #aaa;
            width: 30px;
        }

        /* Admin Elements */
        .admin-hidden {
            display: none;
        }

        .remove-btn {
            background: #F44336;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 5px;
        }

        .remove-btn:hover {
            background: #E53935;
        }

        /* Forms */
        select,
        input[type="text"] {
            padding: 12px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
            background: #333;
            color: white;
            border: 1px solid #444;
            border-radius: 6px;
        }

        button {
            width: 100%;
            padding: 15px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            cursor: pointer;
        }

        .btn-green {
            background: #4CAF50;
        }

        .btn-orange {
            background: #ff9800;
        }

        /* Admin Password Field Styling */
        .admin-password-field {
            width: 100%;
            padding: 5px;
            font-size: 0.8em;
            background: #2a2a2a;
            color: #ccc;
            border: 1px solid #444;
            border-radius: 4px;
            text-align: center;
            margin-bottom: 5px;
        }

        /* History styles (unmodified) */
        .history {
            font-size: 0.85em;
            color: #e0e0e0;
        }

        .history-item {
            padding: 8px 0;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .match-score-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #2196F3;
            margin-right: 15px;
            padding: 5px 10px;
            min-width: 60px;
            text-align: center;
            border-right: 1px solid #333;
        }

        .match-players-stack {
            display: flex;
            flex-direction: column;
            text-align: left;
            flex-grow: 1;
            margin-right: 15px;
        }

        .match-actions-and-date {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
            min-width: 120px;
        }

        .match-timestamp-container {
            font-size: 0.75em;
            color: #888;
            text-align: right;
            line-height: 1;
        }

        /* Modal Styles (unmodified) */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #1e1e1e;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        .modal-content input {
            margin-bottom: 15px;
        }

        .modal-content button {
            width: auto;
            padding: 10px 20px;
            margin-top: 0;
            margin-left: 10px;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
        }
    </style>
</head>

<body>
    <div id="loader-wrapper">
        <h1 class="loader-text">üèì Pong League</h1>
    </div>
    </div>
    <div id="admin-login-modal" class="modal">
        <div class="modal-content">
            <h2>Admin Access</h2>
            <p>Enter the administrator password to enable management features.</p>
            <input type="password" id="modal-admin-password" placeholder="Admin Password" required>
            <div class="modal-buttons">
                <button onclick="document.getElementById('admin-login-modal').style.display='none'"
                    style="background: #555;">Cancel</button>
                <button onclick="handleAdminLogin()" style="background: #2196F3;">Login</button>
            </div>
            <p id="modal-error-message" style="color: #F44336; margin-top: 10px; display: none; font-size: 0.9em;"></p>
        </div>
    </div>

    <div id="rules-modal" class="modal">
        <div class="modal-content" style="max-width: 500px; text-align: left;">
            <h2 style="text-align: center;">üèì Official Ping Pong Rules</h2>
            <p style="font-size: 0.9em; margin-bottom: 15px;">
                These are the basic rules for standard table tennis if you want to play by them, if not enjoy the games
                however you want!
            </p>
            <ol style="padding-left: 20px; font-size: 0.85em; list-style-type: decimal;">
                <li style="margin-bottom: 8px;"><strong>The Serve:</strong> The server must toss the ball upward at
                    least 6 inches and strike it so it first hits their side of the table and then the opponent's side.
                    The serve must start from behind the end line.</li>
                <li style="margin-bottom: 8px;"><strong>Change of Service:</strong> Service changes hands every
                    <b>two</b> points.
                </li>
                <li style="margin-bottom: 8px;"><strong>Scoring:</strong> A game is won by the first player to reach
                    <b>11 points</b> and be at least <b>two points ahead</b> of the opponent. If the score is 10-10
                    (deuce), service alternates after every point until one player gains a two-point lead.
                </li>
                <li style="margin-bottom: 8px;"><strong>Legal Return:</strong> The ball must only be struck after it has
                    bounced once on your side. It must then travel directly over the net and bounce on the opponent's
                    side.</li>
                <li style="margin-bottom: 8px;"><strong>Let:</strong> A serve that hits the net assembly and otherwise
                    lands legally is a "let" and is replayed. There is no limit to the number of lets.</li>
            </ol>
            <div class="modal-buttons" style="margin-top: 20px; justify-content: center;">
                <button onclick="document.getElementById('rules-modal').style.display='none'"
                    style="background: #2196F3; width: 100%; max-width: 150px;">Close</button>
            </div>
        </div>
    </div>

    <div id="tournament-rules-modal" class="modal">
        <div class="modal-content" style="max-width: 500px; text-align: left;">
            <h2 style="text-align: center;">üèÖ Tournament Rules</h2>
            <p style="font-size: 0.9em; margin-bottom: 15px;">
                The following rules apply to all players participating in the tournament.
            </p>
            <ol style="padding-left: 20px; font-size: 0.85em; list-style-type: decimal;">
                <li style="margin-bottom: 8px;"><strong>General Match Rules:</strong> Matches will be played with the
                    rules outlined in the rule page on this website.</li>
                <li style="margin-bottom: 8px;"><strong>Tournament Structure:</strong> Each match will be a <b>best of
                        3</b>. The first player to win <b>2 games</b> wins the match. The grand final will be <b>best of
                        5</b>.</li>
                <li style="margin-bottom: 8px;"><strong>Match Scheduling</strong> Each player is assigned <b>one
                        match</b> per day (excluding days with a scheduled 'bye'). Players must coordinate with their
                    opponent to agree on a time to complete their assigned match.</li>
                <li style="margin-bottom: 8px;"><strong>Forfeiture Policy:</strong> If a player is scheduled to play a
                    match on a specific day and is unable to attend or play the match, that player will <b>forfeit</b>
                    the match.</li>
            </ol>
            <div class="modal-buttons" style="margin-top: 20px; justify-content: center;">
                <button onclick="document.getElementById('tournament-rules-modal').style.display='none'"
                    style="background: #2196F3; width: 100%; max-width: 150px;">Close</button>
            </div>
        </div>
    </div>

    <div id="header-container">
        <h1 id="pong-title">üèì Pong League</h1>
        <span id="rules-icon" onclick="document.getElementById('rules-modal').style.display='flex'">i</span>
    </div>

    {% if admin_note %}
    <div id="league-note" class="top-banner">
        üì£ {{ admin_note }}
    </div>
    {% else %}
    {% if matches %}
    {% set recent_match = matches[0] %}
    <div id="last-match-banner" class="top-banner">
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <div>
                <span style="font-weight: bold; color: #e0e0e0; margin-right: 10px;">{{ recent_match.score }}</span>
                <strong style="color:#4CAF50">{{ recent_match.winner.name }}</strong>
                <span style="font-size: 0.8em; color: #aaa; margin-right: 15px;">
                    ({{ recent_match.winner_pre_elo }}
                    <span style="color: #4CAF50;">+{{ recent_match.winner_post_elo - recent_match.winner_pre_elo
                        }}</span>)
                </span>
                {{ recent_match.loser.name }}
                <span style="font-size: 0.8em; color: #aaa;">
                    ({{ recent_match.loser_pre_elo }}
                    <span style="color: #F44336;">{{ recent_match.loser_post_elo - recent_match.loser_pre_elo }}</span>)
                </span>
            </div>

            <div class="match-timestamp-container" style="text-align: right; margin-left: 15px; flex-shrink: 0;"
                data-utc-date="{{ recent_match.date }}">
                <span class="js-local-datetime">Loading...</span>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <div class="card">
        <div id="header-container">
            <h2>üèÖ Tournament Hub</h2>
            <span id="rules-icon"
                onclick="document.getElementById('tournament-rules-modal').style.display='flex'">i</span>
        </div>

        <div id="tournament-admin-controls" class="admin-hidden"
            style="margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 15px;">
            <p style="color: #bbb; font-size: 0.9em;">Admin Mode: Change Tournament State</p>
            <form action="/admin_start_signup" method="POST" style="display:inline-block; margin-right: 5px;"
                onsubmit="return injectAdminPassword(this)">
                <input type="hidden" name="admin_password" class="admin-password-field-hidden">
                <button type="submit" class="btn-green"
                    style="width: auto; padding: 10px 15px; margin-top: 0; background: #2196F3;">Start Signup</button>
            </form>
            <form action="/admin_start_tournament" method="POST" style="display:inline-block; margin-right: 5px;"
                onsubmit="return injectAdminPassword(this)">
                <input type="hidden" name="admin_password" class="admin-password-field-hidden">
                <button type="submit" class="btn-green"
                    style="width: auto; padding: 10px 15px; margin-top: 0; background: #FF5722;">Start
                    Tournament</button>
            </form>

            <form action="/admin_start_next_round" method="POST" style="display:inline-block; margin-right: 5px;"
                onsubmit="return injectAdminPassword(this)">
                <input type="hidden" name="admin_password" class="admin-password-field-hidden">
                <button type="submit" class="btn-orange" style="width: auto; padding: 10px 15px; margin-top: 0;">Advance
                    Round</button>
            </form>

            <form action="/admin_end_tournament" method="POST" style="display:inline-block;"
                onsubmit="return injectAdminPassword(this)">
                <input type="hidden" name="admin_password" class="admin-password-field-hidden">
                <button type="submit" class="btn-green"
                    style="width: auto; padding: 10px 15px; margin-top: 0; background: #555;">Conclude</button>
            </form>
        </div>

        {% if tournament_state == 1 %}
        <h3 style="color:#2196F3;">Tournament Signup is OPEN!</h3>
        <p style="color:#bbb; font-size: 0.9em;">Participants [{{ signed_up_players | length }}]:
            {% for player in signed_up_players %}
            <span style="color:#ddd; margin-right: 5px;">{{ player.name }}</span>
            {% endfor %}
        </p>

        <form action="/signup_for_tournament" method="POST">
            <label style="display:block; text-align:left; color:#888; margin-top:10px;">Your Name</label>
            <select name="player_id" required>
                <option value="" disabled selected>Select Your Name to Sign Up</option>
                {% for player in players %}
                <option value="{{ player.id }}">{{ player.name }}</option>
                {% endfor %}
                {% for player in inactive_players %}
                <option value="{{ player.id }}">{{ player.name }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn-green" style="background: #2196F3;">Sign Up</button>
        </form>

        {% elif tournament_state >= 2 %}
        {% if tournament_state == 2 %}
        <h3 style="color:#4CAF50;">üèÜ Tournament Bracket (Round {{ max_round_num }} Active)</h3>
        {% else %}
        <h3 style="color:#ff9800;">üèÜ Winner: {{concluded_tournament.winner.name if concluded_tournament and
            concluded_tournament.winner else 'TBD'}}</h3>

        {% endif %}

        {% if all_tournament_matches %}
        <div id="bracket-container">
            <div id="bracket-rounds">
                {% set matches_by_round = all_tournament_matches | groupby('round_num') %}
                {% for round_num, matches in matches_by_round %}
                <div class="bracket-round">
                    {% if matches | length == 1 %}
                    <h4
                        style="margin-bottom: 5px; color: {% if round_num == max_round_num and tournament_state == 2 %} #ffeb3b {% else %} #ccc {% endif %};">
                        Finals</h4>
                    {% elif matches | length == 2 %}
                    <h4
                        style="margin-bottom: 5px; color: {% if round_num == max_round_num and tournament_state == 2 %} #ffeb3b {% else %} #ccc {% endif %};">
                        Semifinals</h4>
                    {% else %}
                    <h4
                        style="margin-bottom: 5px; color: {% if round_num == max_round_num and tournament_state == 2 %} #ffeb3b {% else %} #ccc {% endif %};">
                        Round {{ round_num }}</h4>
                    {% endif %}

                    <div class="round-matches">
                        {% for match in matches %}
                        {% set is_completed = match.winner_id is not none %}
                        {% set is_current_round = match.round_num == max_round_num %}

                        <div class="match-entry {% if is_completed %}completed{% elif not is_current_round %}future{% endif %}"
                            id="match-{{ match.id }}">
                            <div class="match-header">
                                <strong>Match {{ match.match_num }} (Bo{{ match.best_of_games }})</strong>
                                <span
                                    class="match-status {% if is_completed %}completed{% elif not is_current_round %}future{% endif %}">
                                    {% if is_completed %}
                                    COMPLETED
                                    {% elif is_current_round %}
                                    PENDING
                                    {% else %}
                                    TBD
                                    {% endif %}
                                </span>
                            </div>

                            <div class="match-players">
                                {{ match.player1.name if match.player1 else "TBD" }}
                                <span class="vs">vs</span>
                                {{ match.player2.name if match.player2 else "TBD" }}
                            </div>

                            {% if is_completed %}
                            <div class="match-winner {% if match.score == 'BYE' %}bye{% endif %}">
                                Winner: {{ match.winner.name }} ({{ match.score }})
                            </div>

                            {% elif is_current_round and match.player1 and match.player2 and tournament_state == 2 %}
                            <form action="/log_tournament_match/{{ match.id }}" method="POST">
                                <label
                                    style="display:block; text-align:left; color:#888; font-size:0.8em;">Winner</label>
                                <select name="winner_id" required style="padding: 8px;">
                                    <option value="" disabled selected>Select Winner</option>
                                    <option value="{{ match.player1.id }}">{{ match.player1.name }}</option>
                                    <option value="{{ match.player2.id }}">{{ match.player2.name }}</option>
                                </select>
                                <label style="display:block; text-align:left; color:#888; font-size:0.8em;">Score (e.g.,
                                    2-1)</label>
                                <input type="text" name="score" placeholder="Game Score (e.g., 2-1)"
                                    style="padding: 8px;">
                                <button type="submit" class="btn-green" style="padding: 10px; margin-top: 5px;">Log
                                    Match</button>
                            </form>

                            {% elif is_current_round and match.player1 and not match.player2 %}
                            <p style="color:#ddd;">{{ match.player1.name }} received a BYE and advances automatically.
                            </p>

                            {% elif not is_current_round and (not match.player1 or not match.player2) %}
                            <p style="color:#888; font-size: 0.9em;">Players determined by winners of previous round.
                            </p>

                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <p style="color:#888; font-style: italic;">No matches generated. Admin needs to press "Start Tournament".</p>
        {% endif %}

        <p style="color:#bbb; font-size: 0.9em; margin-top: 15px;">
            {% if tournament_state == 2 %}
            {% set incomplete_count = all_tournament_matches | selectattr('round_num', 'equalto', max_round_num) |
            selectattr('winner_id', 'none') | rejectattr('player2', 'none') | list | length %}
            {% if incomplete_count > 0 %}
            <b>{{ incomplete_count }}</b> pending match{{ 'es' if incomplete_count > 1 else '' }} in Round {{
            max_round_num }}.
            {% else %}
            All matches for Round {{ max_round_num }} are completed. Please wait for next round to begin.
            {% endif %}
            {% elif tournament_state == 3 %}
            Tournament concluded on {{ concluded_tournament.end_date.strftime('%B %d, %Y') if concluded_tournament and
            concluded_tournament.end_date else 'an unknown date' }}.
            {% endif %}
        </p>


        {% else %}
        <p style="color:#888;">No tournament currently active or scheduled. Check back later!</p>
        {% endif %}

    </div>

    <div class="card">
        <h2>üèÜ Leaderboard</h2>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>W/L</th>
                    <th>Elo</th>
                    <th id="admin-header" class="admin-hidden">Admin</th>
                </tr>
            </thead>
            <tbody>
                {% for player in players %}
                <tr>
                    <td class="rank">{{ loop.index }}</td>
                    <td>{{ player.name }}</td>
                    <td style="font-size: 0.8em; color: #777;">{{ player.wins }}-{{ player.losses }}</td>
                    <td class="elo">{{ player.elo }}</td>
                    <td id="player-admin-{{ player.id }}" class="admin-hidden" style="width: 120px;">
                        <form action="/remove_player/{{ player.id }}" method="POST" style="margin:0;"
                            onsubmit="return injectAdminPassword(this)">
                            <div class="admin-password-container">
                                <input type="hidden" name="admin_password" class="admin-password-field-hidden">
                                <button type="submit" class="remove-btn">Remove Player</button>
                            </div>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>

            <td colspan="5">
                <div style="margin: 5px 0; display: flex; align-items: center;">
                    <hr style="flex-grow: 1; border: none; border-top: 3px solid #888;">
                    <span style="color: #888; padding: 0 8px; font-size: 12px; font-weight: bold">unranked</span>
                    <hr style="flex-grow: 1; border: none; border-top: 3px solid #888;">
                </div>
            </td>

            {% if inactive_players %}
            <tbody>
                {% for player in inactive_players %}
                <tr>
                    <td class="rank">-</td>
                    <td>{{ player.name }}</td>
                    <td style="font-size: 0.8em; color: #777;">{{ player.wins }}-{{ player.losses }}</td>
                    <td class="elo">{{ player.elo }}</td>
                    <td id="player-admin-{{ player.id }}" class="admin-hidden" style="width: 120px;">
                        <form action="/remove_player/{{ player.id }}" method="POST" style="margin:0;"
                            onsubmit="return injectAdminPassword(this)">
                            <input type="hidden" name="admin_password" class="admin-password-field-hidden">
                            <button type="submit" class="remove-btn">Remove Player</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            {% endif %}
        </table>


    </div>

    <button id="fab-add-match" onclick="document.getElementById('log-match-modal').style.display='flex'">
        +
    </button>

    <div id="log-match-modal" class="modal">
        <div class="modal-content">
            <h2>üìù Log Game</h2>
            <form action="/log_match" method="POST">
                <label>Winner</label>
                <select name="winner" id="winner-select" onchange="updateOpponentOptions('winner')" required>
                    <option value="" disabled selected>Select Winner</option>
                    {% for player in players %}
                    <option value="{{ player.id }}">{{ player.name }}</option>
                    {% endfor %}
                    {% for player in inactive_players %}
                    <option value="{{ player.id }}">{{ player.name }}</option>
                    {% endfor %}
                </select>

                <label>Loser</label>
                <select name="loser" id="loser-select" onchange="updateOpponentOptions('loser')" required>
                    <option value="" disabled selected>Select Loser</option>
                    {% for player in players %}
                    <option value="{{ player.id }}">{{ player.name }}</option>
                    {% endfor %}
                    {% for player in inactive_players %}
                    <option value="{{ player.id }}">{{ player.name }}</option>
                    {% endfor %}
                </select>

                <label>Score (e.g., 21-18)</label>
                <input type="text" name="score" placeholder="21-19">

                <div class="modal-buttons" style="margin-top: 20px;">
                    <button type="button" onclick="document.getElementById('log-match-modal').style.display='none'"
                        style="background: #555; width: auto; margin-top: 0;">Cancel</button>
                    <button type="submit" class="btn-green" style="width: auto; margin-top: 0;">Record Match</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <h3>Add New Player</h3>
        <form action="/add_player" method="POST">
            <input type="text" name="name" placeholder="Player Name" required>
            <button type="submit" style="background: #555;">Add Player</button>
        </form>
    </div>

    <div id="note-admin-card" class="card admin-hidden">
        <h3>üì¢ Update League Note</h3>
        <form action="/update_admin_note" method="POST" onsubmit="return injectAdminPassword(this)">
            <input type="hidden" name="admin_password" class="admin-password-field-hidden">
            <input type="text" name="admin_note" id="admin-note-input"
                placeholder="Enter announcement text (Leave empty to hide)" value="{{ admin_note | default('') }}">
            <button type="submit" class="btn-green" style="background: #ff9800;">Save Note</button>
        </form>
    </div>

    <div class="card history">
        <h3>Recent Games</h3>
        {% for match in matches %}
        <div class="history-item">
            <div class="match-score-display">{{ match.score }}</div>
            <div class="match-players-stack">
                <div class="winner-info">
                    <strong style="color:#4CAF50">{{ match.winner.name }}</strong>
                    <span style="font-size: 0.8em; color: #aaa;">({{ match.winner_pre_elo }}
                        <span style="color: #4CAF50;">+{{ match.winner_post_elo - match.winner_pre_elo }}</span>)</span>
                </div>
                <div class="loser-info">
                    {{ match.loser.name }}
                    <span style="font-size: 0.8em; color: #aaa;">({{ match.loser_pre_elo }}
                        <span style="color: #F44336;">{{ match.loser_post_elo - match.loser_pre_elo }}</span>)</span>
                </div>
            </div>

            <div class="match-actions-and-date">
                <div class="match-timestamp-container" data-utc-date="{{ match.date }}">
                    <span class="js-local-datetime">Loading...</span>
                </div>
                <form id="match-admin-{{ match.id }}" class="admin-hidden" action="/remove_match/{{ match.id }}"
                    method="POST" style="margin:0; width: 120px;" onsubmit="return injectAdminPassword(this)">
                    <input type="hidden" name="admin_password" class="admin-password-field-hidden">
                    <button type="submit" class="remove-btn">Revert Match</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
        // Store the admin password globally after successful modal entry
        let adminPassword = null;
        let clickCount = 0;
        let lastClickTime = 0;
        const DOUBLE_CLICK_TIME = 300;

        // Function to format UTC dates to EST/EDT
        function formatDatesToEst() {
            const dateElements = document.querySelectorAll('.match-timestamp-container');
            const estOptions = {
                month: 'short', day: 'numeric',
                hour: 'numeric', minute: '2-digit',
                hour12: true,
                timeZone: 'America/New_York',
            };

            dateElements.forEach(el => {
                const utcDateString = el.getAttribute('data-utc-date');
                const targetSpan = el.querySelector('.js-local-datetime');
                if (!utcDateString) { targetSpan.textContent = 'No date recorded'; return; }
                try {
                    const date = new Date(utcDateString + 'Z');
                    if (isNaN(date.getTime())) { targetSpan.textContent = 'Invalid Date Format'; return; }
                    const estDateTime = date.toLocaleString('en-US', estOptions);
                    targetSpan.textContent = estDateTime;
                } catch (e) {
                    targetSpan.textContent = 'Error: Date Processing';
                    console.error("Date formatting error:", e);
                }
            });
        }


        document.getElementById('pong-title').addEventListener('click', () => {
            const now = Date.now();
            if (now - lastClickTime > DOUBLE_CLICK_TIME) {
                clickCount = 1;
            } else {
                clickCount++;
            }
            lastClickTime = now;

            if (clickCount === 3) {
                clickCount = 0;
                document.getElementById('admin-login-modal').style.display = 'flex';
                document.getElementById('modal-admin-password').value = '';
                document.getElementById('modal-error-message').style.display = 'none';
                document.getElementById('modal-admin-password').focus();
            }
        });

        function handleAdminLogin() {
            const passwordField = document.getElementById('modal-admin-password');
            const password = passwordField.value;
            const errorMessage = document.getElementById('modal-error-message');
            errorMessage.style.display = 'none';
            errorMessage.textContent = '';

            if (password.trim() === '') {
                errorMessage.textContent = 'Password cannot be empty.';
                errorMessage.style.display = 'block';
                return;
            }

            // 1. Send password to the server for immediate check
            fetch('/check_admin_password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ admin_password: password })
            })
                .then(response => {
                    if (response.ok) {
                        adminPassword = password;
                        document.getElementById('admin-login-modal').style.display = 'none';
                        showAdminFeatures();
                    } else {
                        return response.json().then(data => {
                            errorMessage.textContent = data.message || 'Login failed: Unknown error.';
                            errorMessage.style.display = 'block';
                        }).catch(() => {
                            errorMessage.textContent = 'Server Error during login check.';
                            errorMessage.style.display = 'block';
                        });
                    }
                })
                .catch(error => {
                    errorMessage.textContent = 'Network error during login check.';
                    errorMessage.style.display = 'block';
                    console.error('Error:', error);
                });
        }

        function showAdminFeatures() {
            // Show Admin header column
            document.getElementById('admin-header').classList.remove('admin-hidden');

            // Show player removal buttons
            document.querySelectorAll('td[id^="player-admin-"]').forEach(el => {
                el.classList.remove('admin-hidden');
            });

            // Show match revert buttons
            document.querySelectorAll('form[id^="match-admin-"]').forEach(el => {
                el.classList.remove('admin-hidden');
            });

            // Show the League Note Admin Card
            document.getElementById('note-admin-card').classList.remove('admin-hidden');

            // NEW: Show the Tournament Admin Controls
            document.getElementById('tournament-admin-controls').classList.remove('admin-hidden');
        }

        function injectAdminPassword(form) {
            if (adminPassword) {
                const hiddenField = form.querySelector('.admin-password-field-hidden');
                if (hiddenField) {
                    hiddenField.value = adminPassword;
                    return true;
                }
            }
            console.error("Admin password not set. Blocking submission.");
            return false;
        }

        // Standard functions
        function updateOpponentOptions(changedRole) {
            const winnerSelect = document.getElementById('winner-select');
            const loserSelect = document.getElementById('loser-select');
            const changedSelect = changedRole === 'winner' ? winnerSelect : loserSelect;
            const opponentSelect = changedRole === 'winner' ? loserSelect : winnerSelect;
            const selectedValue = changedSelect.value;
            for (const option of opponentSelect.options) {
                option.disabled = false;
                if (option.value === selectedValue && opponentSelect.value === selectedValue) {
                    opponentSelect.value = "";
                }
            }
            if (selectedValue) {
                for (const option of opponentSelect.options) {
                    if (option.value === selectedValue) {
                        option.disabled = true;
                        break;
                    }
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateOpponentOptions('winner');
            updateOpponentOptions('loser');

            // Hide all admin features initially
            document.getElementById('admin-header').classList.add('admin-hidden');
            document.querySelectorAll('td[id^="player-admin-"]').forEach(el => {
                el.classList.add('admin-hidden');
            });
            document.querySelectorAll('form[id^="match-admin-"]').forEach(el => {
                el.classList.add('admin-hidden');
            });
            document.getElementById('note-admin-card').classList.add('admin-hidden');
            document.getElementById('tournament-admin-controls').classList.add('admin-hidden');

            formatDatesToEst();

            window.addEventListener('load', () => {
                const loader = document.getElementById('loader-wrapper');
                // Display the full animation for 2 seconds
                setTimeout(() => {
                    if (loader) {
                        loader.classList.add('loader-hidden');
                    }
                }, 2000);
            });
        });

        window.onclick = function (event) {
            const logModal = document.getElementById('log-match-modal');
            const adminModal = document.getElementById('admin-login-modal');
            const rulesModal = document.getElementById('rules-modal');
            const tournamentModal = document.getElementById('tournament-rules-modal');

            if (event.target == logModal) logModal.style.display = "none";
            if (event.target == adminModal) adminModal.style.display = "none";
            if (event.target == rulesModal) rulesModal.style.display = "none";
            if (event.target == tournamentModal) tournamentModal.style.display = "none";
        }
    </script>
</body>

</html>